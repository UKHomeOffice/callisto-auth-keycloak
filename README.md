# Callisto Auth Keycloak

This project contains the configuration that needs to be applied to Callisto's Keycloak realm.

The configuration is held in Terraform so that we can create repeatable deployments across environments.

We currently have 3 GitHub workflows.

- Pushes to branches trigger a workflow flow to validate the terraform and check it's formatting
- Merges into main trigger a workflow that applies the terraform configuration
- A nightly workflow runs a terraform plan with a detailed exit code which causes a failure if any changes are detected

## Using Keycloak locally

It is suggested to run Keycloak from within [callisto-localdev solution](https://github.com/UKHomeOffice/callisto-localdev). When run within the localdev solution, it doesn't need any configuration to start development. However, it is possible to run Keycloak manually (check below section).

### Running Keycloak manually

If using the callisto-localdev docker compose, stop the keycloak container by running the following command in the localdev repository folder

```
docker compose stop keycloak
```

Then run the following command to spin up a fresh Keycloak container in the localdev environment

```
docker compose up -d
```

At this point you now have a fresh keycloak instance with no callisto realm. To create the realm
run terraform against this instance to provision the resources.

Currently because we use an S3 backend it is probably easier to comment out the backend configuration
so that Terraform defaults to using local state.

Now when `terraform init --reconfigure` is run any existing state held locally will be ignored
so your state will be empty and therefore in sync with the empty Keycloak instance.

To run the cuurent changes, execute the following commands. _Feel free to export the variables
specified in the command_

```
cd config
terraform init --reconfigure
KEYCLOAK_USER=admin KEYCLOAK_PASSWORD=admin KEYCLOAK_CLIENT_ID=admin-cli KEYCLOAK_URL=http://localhost:50000 terraform apply -var callisto_realm=callisto -var callisto_url=https://web.callisto.localhost -var include_test_users=true
```

Now you can make changes to the config and reapply the terraform config to the keycloak instance

```
KEYCLOAK_USER=admin KEYCLOAK_PASSWORD=admin KEYCLOAK_CLIENT_ID=admin-cli KEYCLOAK_URL=http://localhost:50000 terraform apply -var callisto_realm=callisto -var callisto_url=https://web.callisto.localhost -var include_test_users=true
```

### Callisto UI setup when running Keycloak manually

When running Keycloak manually, update Keycloak local URL in Callisto UI:

In Callisto-UI, update Keycloak URL in .env file (VITE_KC_URL) to match Keycloak localhost address. Restart Callisto-UI docker service to apply changes.

## Test Users

### Using LocalDev solution

When using Keycloak from within [callisto-localdev solution](https://github.com/UKHomeOffice/callisto-localdev), test users are supplied by the solution. Check `config\modules\terraform\test_users\main.tf` for usernames and passwords.

### Interacting with Keycloak users manually

The keycloak_user resource has an initial password which only works for the initial creation. If you wish to test changes to this you would need to manually delete the user and update the terraform state.

After deleting the user in Keycloak run the following command to see a list of all resources held in terraform state

```
terraform state list
```

Find the test user you wish to remove and then remove it from state
E.g.

```
terraform state rm "module.test_users[0].keycloak_user.tester"
```

## Multi-architecture image

Multi-architecture (AMD,ARM) Keycloak (v 15.0.2) image is supplied by the [callisto-localdev solution](https://github.com/UKHomeOffice/callisto-localdev).

If in the future there is a requirement to upgrade Keycloak version for local development, the
corresponding multi-architecture image can be generated by running workflow "Keycloak AMD and ARM"
from GitHub Actions, specifying the desired new version in the "Keycloak version" workflow parameter.
The job can also be triggered manually using GitHub client:

```shell
gh workflow run "Keycloak AMD and ARM" --ref <git_branch> -f keycloak_version=<desired_keycloak_version>
```

## Branch deployments

If for some reason the installation is corrupted, to start again, run `helm uninstall callisto-keycloak` then rerun the
last successful Drone build containing the callisto-keycloak-dev-deploy pipeline.

To create the Callisto realm and terraform client, run the following commands locally from the `/config` directory:

```shell
terraform init -reconfigure -backend-config="region=eu-west-2" -backend-config="access_key=*****" -backend-config="secret_key=*****" -backend-config="bucket=*****" -backend-config="key=terraform/build/callisto-auth-keycloak/callisto-branch"
```

```shell
KEYCLOAK_URL=https://keycloak.dev.callisto-notprod.homeoffice.gov.uk KEYCLOAK_CLIENT_ID=admin-cli KEYCLOAK_USER=admin KEYCLOAK_PASSWORD=admin TF_VAR_callisto_realm=callisto TF_VAR_callisto_url= TF_VAR_include_test_users=true terraform apply
```

Access key and secret key for the terraform s3 bucket can be found in Kubernetes secrets.

You will also need to get the client secret (found in the credentials tab) from the terraform-client in the Callisto
realm in keycloak, and update the `KEYCLOAK_CLIENT_SECRET` in Drone.
